<?php
require_once __DIR__ . '/../../includes/db.php';

$message = '';
$errors = [];

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $siteName    = trim($_POST['site_name'] ?? '');
    $description = trim($_POST['description'] ?? '');
    $niche       = trim($_POST['niche'] ?? '');
    $siteUrl     = trim($_POST['site_url'] ?? '');
    $price       = $_POST['price'] ?? '';
    $dr          = $_POST['dr'] ?? '';
    $traffic     = $_POST['traffic'] ?? '';
    $country     = trim($_POST['country'] ?? '');
    $backlinks   = $_POST['backlinks'] ?? '';

    // Validate inputs
    if ($siteName === '') $errors['site_name'] = "Site Name is required";
    if ($description === '') $errors['description'] = "Description is required";
    if (str_word_count($description) > 500) $errors['description'] = "Description cannot exceed 500 words";
    if ($niche === '') $errors['niche'] = "Select at least one niche";
    if ($siteUrl === '') $errors['site_url'] = "Site URL is required";
    if ($price === '' || $price < 0) $errors['price'] = "Price must be zero or positive";
    if ($dr === '' || $dr < 0) $errors['dr'] = "DR must be zero or positive";
    if ($traffic === '' || $traffic < 0) $errors['traffic'] = "Traffic must be zero or positive";
    if ($country === '') $errors['country'] = "Country is required";
    if ($backlinks === '' || $backlinks < 0) $errors['backlinks'] = "Backlinks must be zero or positive";

    $imgName = null;

    if (!empty($_FILES['site_img']['tmp_name']) && is_uploaded_file($_FILES['site_img']['tmp_name'])) {
        $imgFile = $_FILES['site_img'];
        
        if ($imgFile['error'] === UPLOAD_ERR_OK) {
            $ext = strtolower(pathinfo($imgFile['name'], PATHINFO_EXTENSION));
            $allowed = ['jpg','jpeg','png','gif','webp'];
            
            if (!in_array($ext, $allowed)) {
                $errors['site_img'] = "Invalid image format";
            } else {
                $imgName = uniqid("site_") . "." . $ext;
                $targetDir = $_SERVER['DOCUMENT_ROOT'] . "/linkbuildings/uploads/sites/";
                if (!is_dir($targetDir)) mkdir($targetDir, 0777, true);
                if (!move_uploaded_file($imgFile['tmp_name'], $targetDir . $imgName)) {
                    $errors['site_img'] = "Failed to move uploaded image. Check folder permissions.";
                }
            }
        } else {
            $errors['site_img'] = "Error uploading image";
        }
    }

    // Insert into DB
    if (empty($errors)) {
        $stmt = $pdo->prepare("INSERT INTO sites 
            (site_name, description, niche, site_url, price, dr, traffic, country, backlinks, status, site_img) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', ?)");
        $stmt->execute([$siteName, $description, $niche, $siteUrl, $price, $dr, $traffic, $country, $backlinks, $imgName]);
        $message = "✅ Site added successfully!";
        $_POST = [];
    }
}

// Country & Niche lists
$countries = ["Germany","Spain","Italy","Austria","Sweden","Norway","Denmark","Finland","Portugal","Brazil",
              "Belgium","Netherlands","Romania","Poland","UK","France","Greece","Hungary","Slovakia","Slovenia"];

$nichesList = [
    'automotive','beauty','business, E-business','computer games','construction',
    'cooking','culture, art','diet, weight loss','entertainment','fashion, clothes',
    'family, kids, pregnancy','finance, banking & insurance','health, medical',
    'home & garden, interior','technology','music','real estate','travel, tour, hotels',
    'sports, fitness','agriculture and forestry','wedding','education, science',
    'dating, relationships','food, drink','e-commerce and shopping','news and media',
    'pets','films and TV','jobs and career','nature and hobbies'
];
?>

<div class="bg-white rounded-lg shadow p-6 max-w-full mx-auto">
    <h2 class="text-xl font-bold mb-4">Add New Site</h2>

    <?php if ($message): ?>
        <div class="mb-4 p-3 rounded <?= str_contains($message,'✅') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' ?>">
            <?= htmlspecialchars($message) ?>
        </div>
    <?php endif; ?>

    <form method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-4">

        <!-- Site Name -->
        <div>
            <label class="block text-sm font-medium">Site Name <span class="text-red-600">*</span></label>
            <input type="text" name="site_name" value="<?= htmlspecialchars($_POST['site_name'] ?? '') ?>"
                   class="w-full border rounded p-2">
            <?php if(isset($errors['site_name'])): ?><p class="text-red-600 text-xs"><?= $errors['site_name'] ?></p><?php endif; ?>
        </div>

        <!-- Niche -->
        <div>
            <label class="block text-sm font-medium">Niche <span class="text-red-600">*</span></label>
            <div id="nicheSelect" class="w-full border rounded p-2 relative">
                <div id="selectedNiches" class="flex flex-wrap gap-2 mb-2"></div>
                <input type="text" id="nicheSearch" placeholder="Search niches..." class="w-full border rounded p-2">
                <div id="nicheOptions" class="absolute z-10 bg-white border rounded w-full mt-1 max-h-40 overflow-y-auto hidden"></div>
            </div>
            <input type="hidden" name="niche" id="nicheHidden" value="<?= htmlspecialchars($_POST['niche'] ?? '') ?>">
            <?php if(isset($errors['niche'])): ?><p class="text-red-600 text-xs"><?= $errors['niche'] ?></p><?php endif; ?>
        </div>

        <!-- Site URL -->
        <div>
            <label class="block text-sm font-medium">Site URL <span class="text-red-600">*</span></label>
            <input type="url" name="site_url" value="<?= htmlspecialchars($_POST['site_url'] ?? '') ?>"
                   class="w-full border rounded p-2">
            <?php if(isset($errors['site_url'])): ?><p class="text-red-600 text-xs"><?= $errors['site_url'] ?></p><?php endif; ?>
        </div>

        <!-- Price -->
        <div>
            <label class="block text-sm font-medium">Price (€) <span class="text-red-600">*</span></label>
            <input type="number" step="0.01" name="price" min="0" value="<?= htmlspecialchars($_POST['price'] ?? '') ?>"
                   class="w-full border rounded p-2">
            <?php if(isset($errors['price'])): ?><p class="text-red-600 text-xs"><?= $errors['price'] ?></p><?php endif; ?>
        </div>

        <!-- DR -->
        <div>
            <label class="block text-sm font-medium">DR <span class="text-red-600">*</span></label>
            <input type="number" name="dr" min="0" value="<?= htmlspecialchars($_POST['dr'] ?? '') ?>"
                   class="w-full border rounded p-2">
            <?php if(isset($errors['dr'])): ?><p class="text-red-600 text-xs"><?= $errors['dr'] ?></p><?php endif; ?>
        </div>

        <!-- Traffic -->
        <div>
            <label class="block text-sm font-medium">Traffic <span class="text-red-600">*</span></label>
            <input type="number" name="traffic" min="0" value="<?= htmlspecialchars($_POST['traffic'] ?? '') ?>"
                   class="w-full border rounded p-2">
            <?php if(isset($errors['traffic'])): ?><p class="text-red-600 text-xs"><?= $errors['traffic'] ?></p><?php endif; ?>
        </div>

        <!-- Country -->
        <div>
            <label class="block text-sm font-medium">Country <span class="text-red-600">*</span></label>
            <select name="country" class="w-full border rounded p-2">
                <option value="">-- Select Country --</option>
                <?php foreach($countries as $c): ?>
                    <option value="<?= $c ?>" <?= (($_POST['country'] ?? '')==$c)?'selected':'' ?>><?= $c ?></option>
                <?php endforeach; ?>
            </select>
            <?php if(isset($errors['country'])): ?><p class="text-red-600 text-xs"><?= $errors['country'] ?></p><?php endif; ?>
        </div>

        <!-- Backlinks -->
        <div>
            <label class="block text-sm font-medium">Backlinks <span class="text-red-600">*</span></label>
            <input type="number" name="backlinks" min="0" value="<?= htmlspecialchars($_POST['backlinks'] ?? '') ?>"
                   class="w-full border rounded p-2">
            <?php if(isset($errors['backlinks'])): ?><p class="text-red-600 text-xs"><?= $errors['backlinks'] ?></p><?php endif; ?>
        </div>

        <!-- Site Image -->
        <div>
            <label class="block text-sm font-medium">Site Image <span class="text-red-600">*</span></label>
            <input type="file" name="site_img" class="w-full border rounded p-2" required>
            <?php if(isset($errors['site_img'])): ?><p class="text-red-600 text-xs"><?= $errors['site_img'] ?></p><?php endif; ?>
        </div>

        <!-- Description -->
        <div class="md:col-span-3">
            <label class="block text-sm font-medium">Description <span class="text-red-600">*</span></label>
            <textarea name="description" rows="4" class="w-full border rounded p-2"><?= htmlspecialchars($_POST['description'] ?? '') ?></textarea>
            <?php if(isset($errors['description'])): ?><p class="text-red-600 text-xs"><?= $errors['description'] ?></p><?php endif; ?>
        </div>

        <!-- Submit -->
        <div class="md:col-span-3">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Site</button>
        </div>

    </form>
</div>


</div> <!-- end of form wrapper -->

<?php include '../partials/sites_table.php'; ?>


<script>
// Niche selector
const niches = <?= json_encode($nichesList) ?>;
const nicheInput = document.getElementById('nicheSearch');
const nicheOptions = document.getElementById('nicheOptions');
const selectedNichesDiv = document.getElementById('selectedNiches');
const hiddenInput = document.getElementById('nicheHidden');

let selectedNiches = [];
<?php if(!empty($_POST['niche'])): ?>
selectedNiches = <?= json_encode(explode(',', $_POST['niche'])) ?>;
<?php endif; ?>

function renderOptions() {
    const val = nicheInput.value.toLowerCase();
    nicheOptions.innerHTML = '';
    niches.filter(n => n.toLowerCase().includes(val) && !selectedNiches.includes(n))
           .forEach(n => {
               const div = document.createElement('div');
               div.textContent = n;
               div.className = 'p-2 hover:bg-gray-200 cursor-pointer';
               div.onclick = () => {
                   if(selectedNiches.length<5) selectedNiches.push(n);
                   renderSelected();
                   nicheInput.value = '';
                   nicheOptions.classList.add('hidden');
               };
               nicheOptions.appendChild(div);
           });
    nicheOptions.classList.toggle('hidden', nicheOptions.innerHTML==='');
}

function renderSelected() {
    selectedNichesDiv.innerHTML = '';
    selectedNiches.forEach(n => {
        const span = document.createElement('span');
        span.textContent = n + ' ×';
        span.className = 'bg-blue-100 text-blue-700 px-2 py-1 rounded-full cursor-pointer';
        span.onclick = () => { selectedNiches = selectedNiches.filter(x => x!==n); renderSelected(); };
        selectedNichesDiv.appendChild(span);
    });
    hiddenInput.value = selectedNiches.join(',');
}

renderSelected();
nicheInput.addEventListener('input', renderOptions);
nicheInput.addEventListener('focus', renderOptions);
document.addEventListener('click', e => { if(!e.target.closest('#nicheSelect')) nicheOptions.classList.add('hidden'); });

// Auto-remove alert
setTimeout(() => {
    const alert = document.querySelector('.mb-4.p-3.rounded');
    if (alert) alert.remove();
}, 3000);
</script>
